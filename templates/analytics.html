{% extends "base.html" %}

{% block title %}Analytics - D-Mart Smart Inventory System{% endblock %}

{% block extra_css %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
        <div class="container">
            <!-- Analytics Header -->
            <div class="analytics-container">
                <h2 class="card-title" style="margin-bottom: 1rem;">Real-Time Analytics Dashboard</h2>
                <p style="color: #666; margin-bottom: 1.5rem;">Comprehensive insights into your inventory trends, user interactions, and system performance.</p>
                
                <!-- Key Metrics Grid -->
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h3>Total Analyses</h3>
                        <div class="analytics-value" id="total-analyses">--</div>
                        <p style="color: #999; font-size: 0.9rem; margin-top: 0.5rem;">Inventory analyses performed</p>
                    </div>
                    <div class="analytics-card">
                        <h3>Chatbot Interactions</h3>
                        <div class="analytics-value" id="total-chats">--</div>
                        <p style="color: #999; font-size: 0.9rem; margin-top: 0.5rem;">User questions answered</p>
                    </div>
                    <div class="analytics-card">
                        <h3>AI Responses</h3>
                        <div class="analytics-value" id="ai-responses">--</div>
                        <p style="color: #999; font-size: 0.9rem; margin-top: 0.5rem;">Google Gemini API calls</p>
                    </div>
                    <div class="analytics-card">
                        <h3>Top Product</h3>
                        <div class="analytics-value" id="top-product" style="font-size: 1.2rem;">--</div>
                        <p style="color: #999; font-size: 0.9rem; margin-top: 0.5rem;">Most analyzed</p>
                    </div>
                </div>
            </div>

            <!-- Product Analysis Graphs Section -->
            <div class="card" style="margin-bottom: 2rem;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <div>
                        <h2 class="card-title" style="margin:0;">Top Analyzed Products</h2>
                        <p style="margin:4px 0 0 0;color:var(--muted);font-size:0.95rem;">Actionable insights and stock distribution for your most-analyzed items.</p>
                    </div>
                </div>
                <h2 class="card-title">Top Analyzed Products</h2>
                <p style="color: #666; margin-bottom: 1rem;">Visual summary of the five most frequently analyzed products.</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 0.6rem; margin-top: 0.5rem;">
                    <!-- Product Frequency Bar Chart -->
                    <div class="chart-container" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: 300px;">
                        <h3 style="margin-bottom: 1rem; color: #333;">Product Analysis Frequency</h3>
                        <div style="height: 230px;">
                            <canvas id="productFrequencyChart"></canvas>
                        </div>
                        <div style="margin-top:8px; text-align: right;"><button class="btn-link" onclick="openChartModal(window.productFrequencyChartData, 'Product Analysis Frequency', 'bar')">View full data & expand</button></div>
                    </div>

                    <!-- Product Category Pie Chart -->
                    <div class="chart-container" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: 300px;">
                        <h3 style="margin-bottom: 1rem; color: #333;">Category Distribution</h3>
                        <div style="height: 230px;">
                            <canvas id="productCategoryChart"></canvas>
                        </div>
                        <div style="margin-top:8px; text-align: right;"><button class="btn-link" onclick="openChartModal(window.productCategoryChartData, 'Product Category Distribution', 'doughnut')">View full data & expand</button></div>
                    </div>

                    <!-- Product Stock Distribution -->
                    <div class="chart-container" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: 300px;">
                        <h3 style="margin-bottom: 1rem; color: #333;">Average Stock Levels (units)</h3>
                        <div style="height: 230px;">
                            <canvas id="productStockChart"></canvas>
                        </div>
                        <div style="margin-top:8px; text-align: right;"><button class="btn-link" onclick="openChartModal(window.productStockChartData, 'Average Stock Levels', 'radar')">View full data & expand</button></div>
                    </div>

                    <!-- Product Decision Distribution -->
                    <div class="chart-container" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: 300px;">
                        <h3 style="margin-bottom: 1rem; color: #333;">Recommendation Breakdown</h3>
                        <div style="height: 230px;">
                            <canvas id="productDecisionChart"></canvas>
                        </div>
                        <div style="margin-top:8px; text-align: right;"><button class="btn-link" onclick="openChartModal(window.productDecisionChartData, 'Recommendation Breakdown', 'bar')">View full data & expand</button></div>
                    </div>
                </div>

                <h2 class="card-title" style="margin-top: 1.5rem;">Detailed Analytics</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 0.6rem; margin-top: 0.6rem;">
                    <!-- Category Distribution -->
                    <div class="chart-container" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: 300px;">
                        <h3 style="margin-bottom: 1rem; color: #333;">Category Distribution (all products)</h3>
                        <div style="height: 230px;">
                            <canvas id="categoryChart"></canvas>
                        </div>
                        <div style="margin-top:8px; text-align: right;"><button class="btn-link" onclick="openChartModal(window.categoryChartData, 'Category Distribution', 'doughnut')">View full data & expand</button></div>
                    </div>

                    <!-- Season Distribution -->
                    <div class="chart-container" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: 300px;">
                        <h3 style="margin-bottom: 1rem; color: #333;">Seasonal Analysis</h3>
                        <div style="height: 230px;">
                            <canvas id="seasonChart"></canvas>
                        </div>
                        <div style="margin-top:8px; text-align: right;"><button class="btn-link" onclick="openChartModal(window.seasonChartData, 'Seasonal Analysis', 'bar')">View full data & expand</button></div>
                    </div>

                    <!-- Decision Distribution -->
                    <div class="chart-container" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: 300px;">
                        <h3 style="margin-bottom: 1rem; color: #333;">Decision Breakdown</h3>
                        <div style="height: 230px;">
                            <canvas id="decisionChart"></canvas>
                        </div>
                        <div style="margin-top:8px; text-align: right;"><button class="btn-link" onclick="openChartModal(window.decisionChartData, 'Decision Breakdown', 'pie')">View full data & expand</button></div>
                    </div>

                    <!-- Chat Sources -->
                    <div class="chart-container" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: 300px;">
                        <h3 style="margin-bottom: 1rem; color: #333;">Chatbot Interaction Sources</h3>
                        <div style="height: 230px;">
                            <canvas id="sourcesChart"></canvas>
                        </div>
                        <div style="margin-top:8px; text-align: right;"><button class="btn-link" onclick="openChartModal(window.sourcesChartData, 'Chatbot Interaction Sources', 'radar')">View full data & expand</button></div>
                    </div>
                </div>
            </div>

            <!-- Top Analyzed Products -->
            <div class="card" style="margin-bottom: 2rem;">
                <h2 class="card-title">üèÜ Top Analyzed Products</h2>
                <div class="table-container" style="margin-top: 1.5rem;">
                    <table class="analytics-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Times Analyzed</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="top-products-table">
                            <tr>
                                <td colspan="3" style="text-align: center; color: #999;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Recent Analyses -->
            <div class="card">
                <h2 class="card-title">üìù Recent Inventory Analyses</h2>
                <div class="table-container" style="margin-top: 1.5rem;">
                    <table class="analytics-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Season</th>
                                <th>Current Stock</th>
                                <th>Predicted Demand</th>
                                <th>Decision</th>
                                <th>Optimal Level</th>
                                <th>Safety Stock</th>
                                <th>Quantity Action</th>
                                <th>Recommendation</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="recent-analyses-table">
                            <tr>
                                <td colspan="10" style="text-align: center; color: #999;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Chart Modal -->
        <div id="chartModal" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.5); z-index:20000; align-items:center; justify-content:center; padding: 30px;">
            <div style="background:white; border-radius:10px; max-width:1100px; width:100%; max-height:90vh; overflow:auto; padding:20px; position:relative;">
                <button onclick="closeChartModal()" style="position:absolute; right:12px; top:12px; border:none; background:#eee; padding:6px 10px; border-radius:6px; cursor:pointer;">Close</button>
                <h3 id="chartModalTitle" style="margin-top:0;">Chart Details</h3>
                <div style="height:480px;">
                    <canvas id="chartModalCanvas"></canvas>
                </div>
                <div style="margin-top:12px; overflow:auto; max-height:220px;">
                    <table id="chartModalData" style="width:100%; border-collapse:collapse;">
                    </table>
                </div>
            </div>
        </div>

    <script>
        let categoryChart, seasonChart, decisionChart, sourcesChart;
        let productFrequencyChart, productCategoryChart, productStockChart, productDecisionChart;

        // Load analytics data
        document.addEventListener('DOMContentLoaded', async () => {
            await loadAnalyticsData();
            setInterval(loadAnalyticsData, 30000); // Refresh every 30 seconds
        });

        async function loadAnalyticsData() {
            try {
                const [analyticsRes, recentRes] = await Promise.all([
                    fetch('/api/analytics-data'),
                    fetch('/api/recent-analyses?limit=100')
                ]);
                
                const analyticsData = await analyticsRes.json();
                const recentAnalyses = await recentRes.json();
                
                updateMetrics(analyticsData);
                updateCharts(analyticsData);
                updateTopProducts(analyticsData.top_products);
                updateRecentAnalyses(recentAnalyses);
                updateProductAnalysisCharts(analyticsData.top_products, recentAnalyses);
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        function updateMetrics(data) {
            document.getElementById('total-analyses').textContent = data.total_analyses || 0;
            document.getElementById('total-chats').textContent = data.total_chats || 0;
            document.getElementById('ai-responses').textContent = data.chat_sources?.['google-gemini'] || 0;
            
            if (data.top_products && data.top_products.length > 0) {
                const topProd = data.top_products[0].product_name.split('(')[0].trim();
                document.getElementById('top-product').textContent = topProd;
            }
        }

        function updateCharts(data) {
            // Category Distribution
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            if (categoryChart) categoryChart.destroy();
            categoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data.categories || {}),
                    datasets: [{
                        data: Object.values(data.categories || {}),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe',
                            '#43e97b', '#fa709a', '#fee140', '#30cfd0'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 12, font: { size: 11 }, usePointStyle: true }
                        }
                    }
                }
            });
            // expose data for modal
            window.categoryChartData = { labels: Object.keys(data.categories || {}), datasets: [{ label: 'Count', data: Object.values(data.categories || {}) }] };

            // Season Distribution
            const seasonCtx = document.getElementById('seasonChart').getContext('2d');
            if (seasonChart) seasonChart.destroy();
            seasonChart = new Chart(seasonCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(data.seasons || {}),
                    datasets: [{
                        label: 'Analysis Count',
                        data: Object.values(data.seasons || {}),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: '#667eea',
                        borderWidth: 0,
                        borderRadius: 6,
                        barThickness: 'flex',
                        maxBarThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { bodyFont: { size: 11 }, titleFont: { size: 12 } }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#333', font: { size: 11 } }, grid: { color: 'rgba(0,0,0,0.05)' } },
                        x: { ticks: { color: '#333', font: { size: 11 } }, grid: { display: false } }
                    }
                }
            });
            window.seasonChartData = { labels: Object.keys(data.seasons || {}), datasets: [{ label: 'Analysis Count', data: Object.values(data.seasons || {}) }] };

            // Decision Distribution
            const decisionCtx = document.getElementById('decisionChart').getContext('2d');
            if (decisionChart) decisionChart.destroy();
            decisionChart = new Chart(decisionCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(data.decisions || {}),
                    datasets: [{
                        data: Object.values(data.decisions || {}),
                        backgroundColor: ['#EF476F', '#06D6A0', '#FFD23F'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { size: 10 }, padding: 8, usePointStyle: true } },
                        tooltip: { bodyFont: { size: 10 } }
                    }
                }
            });
            window.decisionChartData = { labels: Object.keys(data.decisions || {}), datasets: [{ label: 'Count', data: Object.values(data.decisions || {}) }] };

            // Chat Sources
            const sourcesCtx = document.getElementById('sourcesChart').getContext('2d');
            if (sourcesChart) sourcesChart.destroy();
            sourcesChart = new Chart(sourcesCtx, {
                type: 'radar',
                data: {
                    labels: Object.keys(data.chat_sources || {}),
                    datasets: [{
                        label: 'Interactions',
                        data: Object.values(data.chat_sources || {}),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderWidth: 2,
                        pointBackgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            pointLabels: { font: { size: 10 } }
                        }
                    },
                    plugins: { tooltip: { bodyFont: { size: 10 } } }
                }
            });
            window.sourcesChartData = { labels: Object.keys(data.chat_sources || {}), datasets: [{ label: 'Interactions', data: Object.values(data.chat_sources || {}) }] };
        }

        function updateTopProducts(products) {
            const tbody = document.getElementById('top-products-table');
            if (!products || products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #999;">No data yet</td></tr>';
                return;
            }

            tbody.innerHTML = products.map(p => `
                <tr>
                    <td><strong>${p.product_name}</strong></td>
                    <td><span class="status-badge" style="background: #667eea15; color: #667eea;">${p.count} times</span></td>
                    <td><small style="color: #999;">Popular</small></td>
                </tr>
            `).join('');
        }

        function updateRecentAnalyses(analyses) {
            const tbody = document.getElementById('recent-analyses-table');
            if (!analyses || analyses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #999;">No data yet</td></tr>';
                return;
            }

            tbody.innerHTML = analyses.map(a => {
                const statusClass = a.decision?.includes('ADD') ? 'status-add' : 
                                   a.decision?.includes('REDUCE') ? 'status-reduce' : 'status-maintain';
                const statusColor = a.decision?.includes('ADD') ? '#EF476F' : 
                                   a.decision?.includes('REDUCE') ? '#F77F00' : '#06D6A0';
                
                const date = new Date(a.created_at).toLocaleDateString();
                
                // Get quantity action
                let quantityAction = '';
                if (a.decision?.includes('ADD')) {
                    const addQty = a.optimal_level - a.current_stock;
                    quantityAction = `<strong style="color: #EF476F;">+${addQty}</strong> units`;
                } else if (a.decision?.includes('REDUCE')) {
                    const reduceQty = a.current_stock - a.optimal_level;
                    quantityAction = `<strong style="color: #F77F00;">-${reduceQty}</strong> units`;
                } else {
                    quantityAction = `<strong style="color: #06D6A0;">${a.current_stock}</strong> units`;
                }
                
                return `
                    <tr>
                        <td><strong>${a.product_name}</strong></td>
                        <td><span style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); padding: 0.25rem 0.5rem; border-radius: 4px;">${a.season}</span></td>
                        <td><strong>${a.current_stock}</strong></td>
                        <td><strong style="color: ${statusColor};">${a.predicted_demand}</strong></td>
                        <td><span style="background: ${statusColor}15; color: ${statusColor}; padding: 0.25rem 0.6rem; border-radius: 4px; font-weight: 600;">${a.decision}</span></td>
                        <td><strong>${a.optimal_level || 'N/A'}</strong></td>
                        <td><strong>${a.safety_stock || 'N/A'}</strong></td>
                        <td>${quantityAction}</td>
                        <td><small>${a.recommendation || 'Monitor'}</small></td>
                        <td><small>${date}</small></td>
                    </tr>
                `;
            }).join('');
        }

        function updateProductAnalysisCharts(topProducts, allAnalyses) {
            // Get top 5 products
            const top5Products = topProducts && topProducts.length > 0 ? topProducts.slice(0, 5) : [];
            
            if (top5Products.length === 0) {
                // Show placeholder if no data
                console.log('No product data available for analysis');
                return;
            }

            // Extract product names and counts
            const productNames = top5Products.map(p => {
                const name = p.product_name.split('(')[0].trim();
                return name.length > 20 ? name.substring(0, 20) + '...' : name;
            });
            const productCounts = top5Products.map(p => p.count);

            // Calculate additional metrics from recent analyses
            const productMetrics = {};
            top5Products.forEach(p => {
                const fullName = p.product_name;
                productMetrics[fullName] = {
                    name: fullName.split('(')[0].trim(),
                    count: p.count,
                    category: fullName.includes('(') ? fullName.split('(')[1].replace(')', '') : 'Unknown',
                    stocks: [],
                    demands: [],
                    decisions: {},
                    optimal_levels: [],
                    safety_levels: [],
                    advices: [],
                    last_analyzed: null
                };
            });

            // Parse recent analyses to extract metrics
            if (allAnalyses && allAnalyses.length > 0) {
                allAnalyses.forEach(a => {
                    const key = Object.keys(productMetrics).find(k => k.includes(a.product_name));
                        if (key && productMetrics[key]) {
                            productMetrics[key].stocks.push(parseInt(a.current_stock) || 0);
                            productMetrics[key].demands.push(parseInt(a.predicted_demand) || 0);
                            // store optimal level and advice if present
                            if (a.optimal_level !== null && a.optimal_level !== undefined) productMetrics[key].optimal_levels.push(parseInt(a.optimal_level));
                            if (a.recommendation) productMetrics[key].advices.push((a.recommendation || '').toString());
                            // safety stock estimate if stored in metadata/advice (best-effort)
                            if (a.safety_stock !== null && a.safety_stock !== undefined) productMetrics[key].safety_levels.push(parseInt(a.safety_stock));
                            // decision tally
                            const decision = a.decision || 'MAINTAIN';
                            productMetrics[key].decisions[decision] = (productMetrics[key].decisions[decision] || 0) + 1;
                            // last analyzed timestamp
                            try {
                                const d = new Date(a.created_at);
                                if (!productMetrics[key].last_analyzed || d > new Date(productMetrics[key].last_analyzed)) {
                                    productMetrics[key].last_analyzed = a.created_at;
                                }
                            } catch (e) {}
                        }
                });
            }

            // Calculate averages
            const productCategories = [];
            const productAvgStocks = [];
            const productAvgDemands = [];
            const decisionData = {};

            top5Products.forEach(p => {
                const fullName = p.product_name;
                const metrics = productMetrics[fullName];
                
                productCategories.push(metrics.category);
                
                const avgStock = metrics.stocks.length > 0 
                    ? Math.round(metrics.stocks.reduce((a, b) => a + b, 0) / metrics.stocks.length)
                    : 0;
                productAvgStocks.push(avgStock);

                const avgDemand = metrics.demands.length > 0
                    ? Math.round(metrics.demands.reduce((a, b) => a + b, 0) / metrics.demands.length)
                    : 0;
                productAvgDemands.push(avgDemand);

                // Collect all decisions
                Object.keys(metrics.decisions).forEach(decision => {
                    decisionData[decision] = (decisionData[decision] || 0) + metrics.decisions[decision];
                });
            });

            // Product Frequency Chart (Top 5)
            const freqCtx = document.getElementById('productFrequencyChart').getContext('2d');
            if (productFrequencyChart) productFrequencyChart.destroy();
            const freqColors = ['#2b6cb0','#2c7a7b','#b7791f','#9f7aea','#dd6b20'];
            productFrequencyChart = new Chart(freqCtx, {
                type: 'bar',
                data: {
                    labels: productNames,
                    datasets: [{
                        label: 'Analysis Count',
                        data: productCounts,
                        backgroundColor: productNames.map((_,i) => freqColors[i % freqColors.length]),
                        borderRadius: 6,
                        barThickness: 'flex',
                        maxBarThickness: 30,
                        borderWidth: 0,
                        categoryPercentage: 0.8,
                        barPercentage: 0.85
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: { bodyFont: { size: 11 }, callbacks: { label: ctx => `${ctx.parsed.x} analyses` } }
                    },
                    scales: {
                        x: { beginAtZero: true, ticks: { color: '#333', font: { size: 11 } } },
                        y: { 
                            ticks: { color: '#333', font: { size: 11 } },
                            grid: { display: false }
                        }
                    }
                }
            });
            // expose data for modal
            window.productFrequencyChartData = { labels: productNames, datasets: [{ label: 'Analysis Count', data: productCounts, backgroundColor: productNames.map((_,i) => freqColors[i % freqColors.length]) }] };

            // Product Category Pie Chart
            const categoryMap = {};
            productCategories.forEach(cat => {
                categoryMap[cat] = (categoryMap[cat] || 0) + 1;
            });
            const categoryCtx = document.getElementById('productCategoryChart').getContext('2d');
            if (productCategoryChart) productCategoryChart.destroy();
            productCategoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryMap),
                    datasets: [{
                        data: Object.values(categoryMap),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe',
                            '#43e97b', '#fa709a', '#fee140'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 8, font: { size: 10 }, usePointStyle: true }
                        },
                        tooltip: { bodyFont: { size: 10 }, padding: 8 }
                    }
                }
            });
            window.productCategoryChartData = { labels: Object.keys(categoryMap), datasets: [{ label: 'Count', data: Object.values(categoryMap) }] };

            // Product Stock Distribution Chart
            const stockCtx = document.getElementById('productStockChart').getContext('2d');
            if (productStockChart) productStockChart.destroy();
            productStockChart = new Chart(stockCtx, {
                type: 'radar',
                data: {
                    labels: productNames,
                    datasets: [{
                        label: 'Average Stock Level (units)',
                        data: productAvgStocks,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.15)',
                        borderWidth: 2,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: { beginAtZero: true, max: Math.max(...productAvgStocks, 100), pointLabels: { font: { size: 11 } } }
                    },
                    plugins: { legend: { display: true, labels: { font: { size: 11 } } }, tooltip: { bodyFont: { size: 11 } } }
                }
            });
            window.productStockChartData = { labels: productNames, datasets: [{ label: 'Average Stock Level (units)', data: productAvgStocks }] };

            // Product Decision Distribution Chart
            const decisionCtx = document.getElementById('productDecisionChart').getContext('2d');
            if (productDecisionChart) productDecisionChart.destroy();
            productDecisionChart = new Chart(decisionCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(decisionData),
                    datasets: [{
                        label: 'Recommendation Count',
                        data: Object.values(decisionData),
                        backgroundColor: (context) => {
                            const label = context.label;
                            if (label.includes('ADD')) return '#06D6A0';
                            if (label.includes('REDUCE')) return '#EF476F';
                            return '#FFD23F';
                        },
                        borderRadius: 6,
                        borderWidth: 0,
                        barThickness: 'flex',
                        maxBarThickness: 50
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'x',
                    plugins: { legend: { display: false }, tooltip: { bodyFont: { size: 11 } } },
                    scales: { y: { beginAtZero: true, ticks: { font: { size: 11 } }, grid: { color: 'rgba(0,0,0,0.05)' } }, x: { ticks: { font: { size: 11 } }, grid: { display: false } } }
                }
            });
            window.productDecisionChartData = { labels: Object.keys(decisionData), datasets: [{ label: 'Recommendation Count', data: Object.values(decisionData) }] };

            // Update detailed metrics table
            updateProductMetricsTable(top5Products, productMetrics);
        }

        function updateProductMetricsTable(topProducts, productMetrics) {
            const tbody = document.getElementById('product-metrics-table');
            if (!topProducts || topProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No data yet</td></tr>';
                return;
            }

            tbody.innerHTML = topProducts.slice(0, 5).map(p => {
                const fullName = p.product_name;
                const metrics = productMetrics[fullName];
                const shortName = metrics.name.length > 25 ? metrics.name.substring(0, 25) + '...' : metrics.name;
                
                const avgStock = metrics.stocks.length > 0 
                    ? Math.round(metrics.stocks.reduce((a, b) => a + b, 0) / metrics.stocks.length)
                    : 0;
                
                const avgDemand = metrics.demands.length > 0
                    ? Math.round(metrics.demands.reduce((a, b) => a + b, 0) / metrics.demands.length)
                    : 0;
                
                const topDecision = Object.keys(metrics.decisions).length ? Object.keys(metrics.decisions).reduce((a, b) => 
                    metrics.decisions[a] > metrics.decisions[b] ? a : b) : 'MAINTAIN';
                
                const decisionClass = topDecision.includes('ADD') ? 'status-add' :
                                     topDecision.includes('REDUCE') ? 'status-reduce' : 'status-maintain';

                // derive optimal and safety stock averages if available
                const optimal = metrics.optimal_levels.length > 0 ? Math.round(metrics.optimal_levels.reduce((a,b)=>a+b,0)/metrics.optimal_levels.length) : '‚Äî';
                const safety = metrics.safety_levels.length > 0 ? Math.round(metrics.safety_levels.reduce((a,b)=>a+b,0)/metrics.safety_levels.length) : '‚Äî';
                const lastAnalyzed = metrics.last_analyzed ? (new Date(metrics.last_analyzed)).toLocaleString() : '‚Äî';
                const recommendationShort = metrics.advices.length > 0 ? metrics.advices[0].substring(0,80) + (metrics.advices[0].length>80?'...':'') : '‚Äî';

                return `
                    <tr>
                        <td><strong>${shortName}</strong></td>
                        <td>${metrics.category}</td>
                        <td><span class="status-badge" style="background: #667eea15; color: #667eea;">${metrics.count}</span></td>
                        <td>${avgStock} units</td>
                        <td>${avgDemand} units</td>
                        <td><span class="status-badge ${decisionClass}">${topDecision}</span></td>
                        <td>${optimal}</td>
                        <td>${safety}</td>
                        <td>${lastAnalyzed}</td>
                        <td style="max-width:260px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${recommendationShort}</td>
                    </tr>
                `;
            }).join('');
        }

        // Modal for expanded chart view + data table
        let modalChart = null;
        function openChartModal(chartData, title = 'Chart', type = 'bar') {
            if (!chartData || !chartData.labels) return;
            const modal = document.getElementById('chartModal');
            const modalTitle = document.getElementById('chartModalTitle');
            const modalCanvas = document.getElementById('chartModalCanvas').getContext('2d');
            const modalTable = document.getElementById('chartModalData');

            modalTitle.textContent = title;

            // Render table
            modalTable.innerHTML = '';
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th>Label</th>' + chartData.datasets.map(ds => `<th>${ds.label}</th>`).join('');
            modalTable.appendChild(headerRow);

            chartData.labels.forEach((lbl, i) => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${lbl}</td>` + chartData.datasets.map(ds => `<td>${ds.data[i] ?? '-'}</td>`).join('');
                modalTable.appendChild(row);
            });

            // Render large chart
            if (modalChart) { try { modalChart.destroy(); } catch(e){} }
            modalChart = new Chart(modalCanvas, {
                type: type,
                data: chartData,
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });

            modal.style.display = 'block';
        }

        function closeChartModal(){
            const modal = document.getElementById('chartModal');
            modal.style.display = 'none';
            if (modalChart) { try { modalChart.destroy(); modalChart = null; } catch(e){} }
        }

    </script>
{% endblock %}
