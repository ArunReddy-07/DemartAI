{% extends "base.html" %}

{% block title %}Analytics - D-Mart Smart Inventory System{% endblock %}

{% block extra_css %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
        <div class="container">
            <!-- Analytics Header -->
            <div class="analytics-container">
                <h2 class="card-title" style="margin-bottom: 1rem;">üìä Real-Time Analytics Dashboard</h2>
                <p style="color: #666; margin-bottom: 1.5rem;">Comprehensive insights into your inventory trends, user interactions, and system performance.</p>
                
                <!-- Key Metrics Grid -->
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h3>üì¶ Total Analyses</h3>
                        <div class="analytics-value" id="total-analyses">--</div>
                        <p style="color: #999; font-size: 0.9rem; margin-top: 0.5rem;">Inventory analyses performed</p>
                    </div>
                    <div class="analytics-card">
                        <h3>üí¨ Chatbot Interactions</h3>
                        <div class="analytics-value" id="total-chats">--</div>
                        <p style="color: #999; font-size: 0.9rem; margin-top: 0.5rem;">User questions answered</p>
                    </div>
                    <div class="analytics-card">
                        <h3>üìà AI Responses</h3>
                        <div class="analytics-value" id="ai-responses">--</div>
                        <p style="color: #999; font-size: 0.9rem; margin-top: 0.5rem;">Google Gemini API calls</p>
                    </div>
                    <div class="analytics-card">
                        <h3>üéØ Top Product</h3>
                        <div class="analytics-value" id="top-product" style="font-size: 1.2rem;">--</div>
                        <p style="color: #999; font-size: 0.9rem; margin-top: 0.5rem;">Most analyzed</p>
                    </div>
                </div>
            </div>

            <!-- Product Analysis Graphs Section -->
            <div class="card" style="margin-bottom: 2rem;">
                <h2 class="card-title">üéØ Top 5 Products Analysis</h2>
                <p style="color: #666; margin-bottom: 1rem;">Detailed analysis of your 5 most analyzed products with visual comparisons.</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem; margin-top: 1.5rem;">
                    <!-- Product Frequency Bar Chart -->
                    <div class="chart-container" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                        <h3 style="margin-bottom: 1rem; color: #333;">üìä Product Analysis Count</h3>
                        <canvas id="productFrequencyChart"></canvas>
                    </div>

                    <!-- Product Category Pie Chart -->
                    <div class="chart-container" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                        <h3 style="margin-bottom: 1rem; color: #333;">üè∑Ô∏è Product Categories</h3>
                        <canvas id="productCategoryChart"></canvas>
                    </div>

                    <!-- Product Stock Distribution -->
                    <div class="chart-container" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                        <h3 style="margin-bottom: 1rem; color: #333;">üì¶ Average Stock Levels</h3>
                        <canvas id="productStockChart"></canvas>
                    </div>

                    <!-- Product Decision Distribution -->
                    <div class="chart-container" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                        <h3 style="margin-bottom: 1rem; color: #333;">‚ö° Stock Recommendations</h3>
                        <canvas id="productDecisionChart"></canvas>
                    </div>
                </div>

                <!-- Detailed Product Table -->
                <div class="table-container" style="margin-top: 2rem;">
                    <h3 style="margin-bottom: 1rem; color: #333;">üìã Detailed Product Metrics</h3>
                    <table class="analytics-table">
                        <thead>
                            <tr>
                                <th>Product Name</th>
                                <th>Category</th>
                                <th>Times Analyzed</th>
                                <th>Avg Stock</th>
                                <th>Avg Demand</th>
                                <th>Top Decision</th>
                            </tr>
                        </thead>
                        <tbody id="product-metrics-table">
                            <tr>
                                <td colspan="6" style="text-align: center; color: #999;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

                <h2 class="card-title">üìä Detailed Analytics</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem; margin-top: 2rem;">
                    <!-- Category Distribution -->
                    <div class="chart-container" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                        <h3 style="margin-bottom: 1rem; color: #333;">Category Distribution</h3>
                        <canvas id="categoryChart"></canvas>
                    </div>

                    <!-- Season Distribution -->
                    <div class="chart-container" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                        <h3 style="margin-bottom: 1rem; color: #333;">Seasonal Analyses</h3>
                        <canvas id="seasonChart"></canvas>
                    </div>

                    <!-- Decision Distribution -->
                    <div class="chart-container" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                        <h3 style="margin-bottom: 1rem; color: #333;">Stock Decisions</h3>
                        <canvas id="decisionChart"></canvas>
                    </div>

                    <!-- Chat Sources -->
                    <div class="chart-container" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                        <h3 style="margin-bottom: 1rem; color: #333;">Chatbot Sources</h3>
                        <canvas id="sourcesChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Top Analyzed Products -->
            <div class="card" style="margin-bottom: 2rem;">
                <h2 class="card-title">üèÜ Top Analyzed Products</h2>
                <div class="table-container" style="margin-top: 1.5rem;">
                    <table class="analytics-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Times Analyzed</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="top-products-table">
                            <tr>
                                <td colspan="3" style="text-align: center; color: #999;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Recent Analyses -->
            <div class="card">
                <h2 class="card-title">üìù Recent Inventory Analyses</h2>
                <div class="table-container" style="margin-top: 1.5rem;">
                    <table class="analytics-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Season</th>
                                <th>Stock</th>
                                <th>Demand</th>
                                <th>Decision</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="recent-analyses-table">
                            <tr>
                                <td colspan="6" style="text-align: center; color: #999;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    <script>
        let categoryChart, seasonChart, decisionChart, sourcesChart;
        let productFrequencyChart, productCategoryChart, productStockChart, productDecisionChart;

        // Load analytics data
        document.addEventListener('DOMContentLoaded', async () => {
            await loadAnalyticsData();
            setInterval(loadAnalyticsData, 30000); // Refresh every 30 seconds
        });

        async function loadAnalyticsData() {
            try {
                const [analyticsRes, recentRes] = await Promise.all([
                    fetch('/api/analytics-data'),
                    fetch('/api/recent-analyses?limit=100')
                ]);
                
                const analyticsData = await analyticsRes.json();
                const recentAnalyses = await recentRes.json();
                
                updateMetrics(analyticsData);
                updateCharts(analyticsData);
                updateTopProducts(analyticsData.top_products);
                updateRecentAnalyses(recentAnalyses);
                updateProductAnalysisCharts(analyticsData.top_products, recentAnalyses);
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        function updateMetrics(data) {
            document.getElementById('total-analyses').textContent = data.total_analyses || 0;
            document.getElementById('total-chats').textContent = data.total_chats || 0;
            document.getElementById('ai-responses').textContent = data.chat_sources?.['google-gemini'] || 0;
            
            if (data.top_products && data.top_products.length > 0) {
                const topProd = data.top_products[0].product_name.split('(')[0].trim();
                document.getElementById('top-product').textContent = topProd;
            }
        }

        function updateCharts(data) {
            // Category Distribution
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            if (categoryChart) categoryChart.destroy();
            categoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data.categories || {}),
                    datasets: [{
                        data: Object.values(data.categories || {}),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe',
                            '#43e97b', '#fa709a', '#fee140', '#30cfd0'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 12 } }
                        }
                    }
                }
            });

            // Season Distribution
            const seasonCtx = document.getElementById('seasonChart').getContext('2d');
            if (seasonChart) seasonChart.destroy();
            seasonChart = new Chart(seasonCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(data.seasons || {}),
                    datasets: [{
                        label: 'Analyses',
                        data: Object.values(data.seasons || {}),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: '#667eea',
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Decision Distribution
            const decisionCtx = document.getElementById('decisionChart').getContext('2d');
            if (decisionChart) decisionChart.destroy();
            decisionChart = new Chart(decisionCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(data.decisions || {}),
                    datasets: [{
                        data: Object.values(data.decisions || {}),
                        backgroundColor: ['#EF476F', '#06D6A0', '#FFD23F'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Chat Sources
            const sourcesCtx = document.getElementById('sourcesChart').getContext('2d');
            if (sourcesChart) sourcesChart.destroy();
            sourcesChart = new Chart(sourcesCtx, {
                type: 'radar',
                data: {
                    labels: Object.keys(data.chat_sources || {}),
                    datasets: [{
                        label: 'Interactions',
                        data: Object.values(data.chat_sources || {}),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderWidth: 2,
                        pointBackgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        r: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateTopProducts(products) {
            const tbody = document.getElementById('top-products-table');
            if (!products || products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #999;">No data yet</td></tr>';
                return;
            }

            tbody.innerHTML = products.map(p => `
                <tr>
                    <td><strong>${p.product_name}</strong></td>
                    <td><span class="status-badge" style="background: #667eea15; color: #667eea;">${p.count} times</span></td>
                    <td><small style="color: #999;">Popular</small></td>
                </tr>
            `).join('');
        }

        function updateRecentAnalyses(analyses) {
            const tbody = document.getElementById('recent-analyses-table');
            if (!analyses || analyses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No data yet</td></tr>';
                return;
            }

            tbody.innerHTML = analyses.map(a => {
                const statusClass = a.decision?.includes('ADD') ? 'status-add' : 
                                   a.decision?.includes('REDUCE') ? 'status-reduce' : 'status-maintain';
                const date = new Date(a.created_at).toLocaleDateString();
                return `
                    <tr>
                        <td>${a.product_name}</td>
                        <td>${a.season}</td>
                        <td>${a.current_stock}</td>
                        <td>${a.predicted_demand}</td>
                        <td><span class="status-badge ${statusClass}">${a.decision}</span></td>
                        <td>${date}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateProductAnalysisCharts(topProducts, allAnalyses) {
            // Get top 5 products
            const top5Products = topProducts && topProducts.length > 0 ? topProducts.slice(0, 5) : [];
            
            if (top5Products.length === 0) {
                // Show placeholder if no data
                console.log('No product data available for analysis');
                return;
            }

            // Extract product names and counts
            const productNames = top5Products.map(p => {
                const name = p.product_name.split('(')[0].trim();
                return name.length > 20 ? name.substring(0, 20) + '...' : name;
            });
            const productCounts = top5Products.map(p => p.count);

            // Calculate additional metrics from recent analyses
            const productMetrics = {};
            top5Products.forEach(p => {
                const fullName = p.product_name;
                productMetrics[fullName] = {
                    name: fullName.split('(')[0].trim(),
                    count: p.count,
                    category: fullName.includes('(') ? fullName.split('(')[1].replace(')', '') : 'Unknown',
                    stocks: [],
                    demands: [],
                    decisions: {}
                };
            });

            // Parse recent analyses to extract metrics
            if (allAnalyses && allAnalyses.length > 0) {
                allAnalyses.forEach(a => {
                    const key = Object.keys(productMetrics).find(k => k.includes(a.product_name));
                    if (key && productMetrics[key]) {
                        productMetrics[key].stocks.push(parseInt(a.current_stock) || 0);
                        productMetrics[key].demands.push(parseInt(a.predicted_demand) || 0);
                        
                        const decision = a.decision || 'MAINTAIN';
                        productMetrics[key].decisions[decision] = (productMetrics[key].decisions[decision] || 0) + 1;
                    }
                });
            }

            // Calculate averages
            const productCategories = [];
            const productAvgStocks = [];
            const productAvgDemands = [];
            const decisionData = {};

            top5Products.forEach(p => {
                const fullName = p.product_name;
                const metrics = productMetrics[fullName];
                
                productCategories.push(metrics.category);
                
                const avgStock = metrics.stocks.length > 0 
                    ? Math.round(metrics.stocks.reduce((a, b) => a + b, 0) / metrics.stocks.length)
                    : 0;
                productAvgStocks.push(avgStock);

                const avgDemand = metrics.demands.length > 0
                    ? Math.round(metrics.demands.reduce((a, b) => a + b, 0) / metrics.demands.length)
                    : 0;
                productAvgDemands.push(avgDemand);

                // Collect all decisions
                Object.keys(metrics.decisions).forEach(decision => {
                    decisionData[decision] = (decisionData[decision] || 0) + metrics.decisions[decision];
                });
            });

            // Product Frequency Chart
            const freqCtx = document.getElementById('productFrequencyChart').getContext('2d');
            if (productFrequencyChart) productFrequencyChart.destroy();
            productFrequencyChart = new Chart(freqCtx, {
                type: 'bar',
                data: {
                    labels: productNames,
                    datasets: [{
                        label: 'Times Analyzed',
                        data: productCounts,
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.9)',
                            'rgba(118, 75, 162, 0.9)',
                            'rgba(240, 147, 251, 0.9)',
                            'rgba(79, 172, 254, 0.9)',
                            'rgba(0, 242, 254, 0.9)'
                        ],
                        borderRadius: 8,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });

            // Product Category Pie Chart
            const categoryMap = {};
            productCategories.forEach(cat => {
                categoryMap[cat] = (categoryMap[cat] || 0) + 1;
            });
            const categoryCtx = document.getElementById('productCategoryChart').getContext('2d');
            if (productCategoryChart) productCategoryChart.destroy();
            productCategoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryMap),
                    datasets: [{
                        data: Object.values(categoryMap),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe',
                            '#43e97b', '#fa709a', '#fee140'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 11 } }
                        }
                    }
                }
            });

            // Product Stock Distribution Chart
            const stockCtx = document.getElementById('productStockChart').getContext('2d');
            if (productStockChart) productStockChart.destroy();
            productStockChart = new Chart(stockCtx, {
                type: 'radar',
                data: {
                    labels: productNames,
                    datasets: [{
                        label: 'Avg Stock Level',
                        data: productAvgStocks,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.15)',
                        borderWidth: 2,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        r: { beginAtZero: true, max: Math.max(...productAvgStocks, 100) }
                    },
                    plugins: {
                        legend: { display: true }
                    }
                }
            });

            // Product Decision Distribution Chart
            const decisionCtx = document.getElementById('productDecisionChart').getContext('2d');
            if (productDecisionChart) productDecisionChart.destroy();
            productDecisionChart = new Chart(decisionCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(decisionData),
                    datasets: [{
                        label: 'Recommendation Count',
                        data: Object.values(decisionData),
                        backgroundColor: (context) => {
                            const label = context.label;
                            if (label.includes('ADD')) return '#06D6A0';
                            if (label.includes('REDUCE')) return '#EF476F';
                            return '#FFD23F';
                        },
                        borderRadius: 8,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    indexAxis: 'x',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Update detailed metrics table
            updateProductMetricsTable(top5Products, productMetrics);
        }

        function updateProductMetricsTable(topProducts, productMetrics) {
            const tbody = document.getElementById('product-metrics-table');
            if (!topProducts || topProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No data yet</td></tr>';
                return;
            }

            tbody.innerHTML = topProducts.slice(0, 5).map(p => {
                const fullName = p.product_name;
                const metrics = productMetrics[fullName];
                const shortName = metrics.name.length > 25 ? metrics.name.substring(0, 25) + '...' : metrics.name;
                
                const avgStock = metrics.stocks.length > 0 
                    ? Math.round(metrics.stocks.reduce((a, b) => a + b, 0) / metrics.stocks.length)
                    : 0;
                
                const avgDemand = metrics.demands.length > 0
                    ? Math.round(metrics.demands.reduce((a, b) => a + b, 0) / metrics.demands.length)
                    : 0;
                
                const topDecision = Object.keys(metrics.decisions).reduce((a, b) => 
                    metrics.decisions[a] > metrics.decisions[b] ? a : b, 'MAINTAIN');
                
                const decisionClass = topDecision.includes('ADD') ? 'status-add' :
                                     topDecision.includes('REDUCE') ? 'status-reduce' : 'status-maintain';

                return `
                    <tr>
                        <td><strong>${shortName}</strong></td>
                        <td>${metrics.category}</td>
                        <td><span class="status-badge" style="background: #667eea15; color: #667eea;">${metrics.count}</span></td>
                        <td>${avgStock} units</td>
                        <td>${avgDemand} units</td>
                        <td><span class="status-badge ${decisionClass}">${topDecision}</span></td>
                    </tr>
                `;
            }).join('');
        }

    </script>
{% endblock %}
